# Phase 4.6: User Settings Implementation

## Overview

Complete user settings system with persistent preferences for weight units, rest timer defaults, and haptic feedback control.

## Features Implemented

### ✅ Settings Screen UI
- **Weight Unit Toggle**: Switch between lbs and kg with visual toggle button
- **Default Rest Time**: Grid of preset times (30s, 60s, 90s, 120s, 180s, 240s) plus custom input option
- **Haptic Feedback Toggle**: Enable/disable haptics throughout the app
- **Reset All Data**: Dangerous action with confirmation dialog to delete all user data
- **Version Display**: Shows current app version

### ✅ Database Layer
- **Settings Repository**: [src/lib/db/repositories/settings.ts](../src/lib/db/repositories/settings.ts)
  - `getSettings()`: Load user settings, creates defaults if none exist
  - `updateSettings()`: Update specific settings
  - `resetSettings()`: Reset to default values
  - `deleteAllData()`: Nuclear option to wipe all workout data

- **Database Schema**: Already existed in [src/lib/db/schema.ts](../src/lib/db/schema.ts)
  - `user_settings` table with weight_unit, default_rest_time, enable_haptics fields

### ✅ State Management
- **Settings Store**: [src/stores/settingsStore.ts](../src/stores/settingsStore.ts)
  - React Context provider for global settings access
  - Hooks for easy access:
    - `useSettings()`: Full settings context
    - `useWeightUnit()`: Get current weight unit
    - `useDefaultRestTime()`: Get default rest duration
    - `useHapticsEnabled()`: Check if haptics are enabled

- **SettingsProvider**: Wraps entire app in [app/_layout.tsx](../app/_layout.tsx)
  - Auto-loads settings on app start
  - Provides settings to all screens

### ✅ Weight Display System
- **Formatters**: [src/lib/utils/formatters.ts](../src/lib/utils/formatters.ts)
  - `formatWeight(weight, unit)`: Convert and format weight with unit
  - `formatDuration(seconds)`: Format durations (e.g., "1h 23m")
  - `formatDate()`, `formatDateTime()`, `formatRelativeDate()`: Date formatting utilities

- **Weight Display Hook**: [src/hooks/useWeightDisplay.ts](../src/hooks/useWeightDisplay.ts)
  - `displayWeight(weight)`: Format weight for display with user's unit
  - `getUnit()`: Get current unit string
  - `convertWeight(weight)`: Convert weight value without unit label
  - `parseWeight(value)`: Convert user input to storage format (lbs)

**Storage Convention**: All weights stored in **lbs** in database, converted to kg on display if user preference is kg.

### ✅ Integration with Existing Features
- **Rest Timer**: [app/rest-timer.tsx](../app/rest-timer.tsx)
  - Uses `useDefaultRestTime()` for initial duration if none specified
  - Uses `useHapticsEnabled()` to conditionally trigger haptic feedback
  - Respects user preference on timer completion, pause/resume, and button presses

## File Structure

```
app/
├── _layout.tsx                          # Wrapped with SettingsProvider
└── (tabs)/
    └── settings.tsx                     # Settings screen UI

src/
├── stores/
│   └── settingsStore.ts                 # Settings context and hooks
├── lib/
│   ├── db/repositories/
│   │   └── settings.ts                  # Database operations for settings
│   └── utils/
│       └── formatters.ts                # Weight and date formatting utilities
└── hooks/
    └── useWeightDisplay.ts              # Hook for weight display/conversion
```

## Settings Screen Features

### Weight Unit Preference
- **Visual Toggle**: Segmented control showing "lbs" and "kg"
- **Immediate Update**: Changes reflected instantly across app
- **Conversion**: All stored weights (in lbs) automatically converted for display

### Default Rest Time
- **Preset Options**: 30s, 60s, 90s (default), 120s, 180s, 240s
- **Custom Input**: Alert prompt for custom duration (0-600 seconds)
- **Visual Feedback**: Selected time highlighted in primary color
- **Used By**: Rest timer modal when no duration specified

### Haptic Feedback
- **Toggle Switch**: Enable/disable haptics globally
- **Affects**:
  - Rest timer: completion alerts, button presses
  - Future: Set completion, PR celebrations, etc.
- **Graceful Degradation**: App works without haptics if unavailable

### Reset All Data
- **Destructive Action**: Styled in red with warning icon
- **Confirmation Dialog**: Details what will be deleted
- **Deletes**:
  - All workout sessions
  - All templates
  - All exercises and sets
  - All PR records
  - Sync queue items
- **Preserves**: Settings (reset to defaults)

## Default Values

```typescript
const DEFAULT_SETTINGS = {
  weightUnit: 'lbs',
  defaultRestTime: 90,      // seconds
  enableHaptics: true,
  enableSyncReminders: true  // For future Phase 5
};
```

## Usage Examples

### In a Component

```typescript
import { useSettings, useWeightUnit } from '@/src/stores/settingsStore';
import { useWeightDisplay } from '@/src/hooks/useWeightDisplay';

function MyComponent() {
  const { settings } = useSettings();
  const { displayWeight, getUnit } = useWeightDisplay();

  // Display weight with user's preferred unit
  const formattedWeight = displayWeight(135);  // "135 lbs" or "61.2 kg"

  // Get unit for input labels
  const unit = getUnit();  // "lbs" or "kg"

  return (
    <Text>{formattedWeight}</Text>
  );
}
```

### Updating Settings

```typescript
import { useSettings } from '@/src/stores/settingsStore';

function SettingsComponent() {
  const { updateWeightUnit, updateDefaultRestTime } = useSettings();

  // Switch weight unit
  await updateWeightUnit('kg');

  // Update rest time
  await updateDefaultRestTime(120);
}
```

## Design Decisions

### Why Store in lbs?
- **Consistency**: Single source of truth in database
- **Conversion on Display**: Simpler logic, no migration needed
- **US Market**: Default target market uses lbs
- **Easy Conversion**: Clean conversion factor (1 lb = 0.453592 kg)

### Why React Context for Settings?
- **Global Access**: Settings needed throughout app
- **Single Load**: Load once, available everywhere
- **No Prop Drilling**: Avoid passing through many components
- **Performance**: Context re-renders only consumers when changed

### Why Separate Weight Display Hook?
- **Reusability**: Common pattern across many screens
- **Encapsulation**: Conversion logic in one place
- **Type Safety**: Ensures consistent weight handling
- **Easy Migration**: If storage format changes, update one file

## Migration from Hardcoded "lbs"

Previously, all weight displays showed hardcoded "lbs":
```typescript
<Text>{weight} lbs</Text>
```

Now use the weight display hook:
```typescript
const { displayWeight, getUnit } = useWeightDisplay();
<Text>{displayWeight(weight)}</Text>

// Or for input labels:
<Text>{getUnit()}</Text>
```

## Testing Checklist

- [x] Settings load on app start
- [x] Default settings created if none exist
- [x] Weight unit toggle switches between lbs/kg
- [x] Default rest time presets work
- [x] Custom rest time input validates range
- [x] Haptics toggle updates setting
- [x] Haptics respected in rest timer
- [x] Rest timer uses default rest time
- [x] Reset all data shows confirmation
- [x] Reset all data deletes all workout data
- [x] Settings persist across app restarts
- [x] Weight display hook formats correctly
- [x] Weight conversion math is accurate

## Future Enhancements (Not in MVP)

- [ ] Sync reminder preferences (Phase 5)
- [ ] Theme selection (light/dark/auto)
- [ ] Date format preferences
- [ ] Language selection
- [ ] Export/import settings
- [ ] Backup/restore functionality
- [ ] Sound preferences for rest timer
- [ ] Keep screen awake during workout

## Files Modified

1. [app/(tabs)/settings.tsx](../app/(tabs)/settings.tsx) - Complete settings UI
2. [app/_layout.tsx](../app/_layout.tsx) - Wrapped with SettingsProvider
3. [app/rest-timer.tsx](../app/rest-timer.tsx) - Uses settings for defaults and haptics
4. [src/stores/settingsStore.ts](../src/stores/settingsStore.ts) - Created settings context
5. [src/lib/db/repositories/settings.ts](../src/lib/db/repositories/settings.ts) - Created settings repository
6. [src/lib/utils/formatters.ts](../src/lib/utils/formatters.ts) - Added formatting utilities
7. [src/hooks/useWeightDisplay.ts](../src/hooks/useWeightDisplay.ts) - Created weight display hook
8. [PROJECT_GUIDELINES.md](../PROJECT_GUIDELINES.md) - Updated status and guidelines

## Dependencies

No new dependencies required. Uses:
- `expo-router` - Already in use
- `expo-sqlite` - Already in use
- `expo-haptics` - Already in use
- React Context API - Built-in

## Notes

- Settings are stored as a single row in the `user_settings` table
- First settings access creates default settings if none exist
- Weight unit changes do NOT modify stored weights (conversion on display only)
- Reset all data is irreversible - shows clear warning
- Haptics may not be available on all devices (handled gracefully)

---

**Phase 4.6 Complete**: User settings system fully implemented with weight units, rest timer defaults, and haptics control.
